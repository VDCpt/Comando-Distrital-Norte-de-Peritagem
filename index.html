<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VDC | Unidade de Peritagem Forense - Sistema de Auditoria Fiscal v5.1</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- CSS Local -->
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Modal de Inicialização -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-content">
            <h2><i class="fas fa-shield-alt"></i> SISTEMA DE PERITAGEM FORENSE VDC v5.1</h2>
            <p><strong>REESTRUTURAÇÃO DE AUDITORIA - VALIDAÇÃO HIERÁRQUICA</strong></p>
            <p>Este sistema opera com prioridade de ingestão: primeiro carregue o ficheiro de controlo de autenticidade (.csv), depois os documentos fiscais.</p>
            <p style="color: #93c5fd; font-size: 1rem; margin-top: 25px; padding: 15px; background: rgba(30, 64, 175, 0.1); border-radius: 10px;">
                <i class="fas fa-info-circle"></i> Cada documento será validado contra hashes pré-registadas no ficheiro de controlo.
            </p>
            <button class="modal-btn" id="closeModalBtn">
                <i class="fas fa-check-circle"></i> INICIAR SISTEMA DE PERITAGEM
            </button>
        </div>
    </div>

    <div class="container">
        <!-- Cabeçalho -->
        <header>
            <div class="header-top">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                    <h1><i class="fas fa-balance-scale"></i> SISTEMA DE PERITAGEM FORENSE VDC v5.1</h1>
                    <div class="vdc-banner" style="text-align: right;">
                        <p class="vdc">ANÁLISE FISCAL AUTOMATIZADA</p>
                        <h2>CERTIFICAÇÃO DIGITAL</h2>
                    </div>
                </div>
            </div>
            
            <!-- SECÇÃO DE CONFIGURAÇÃO -->
            <div class="config-section">
                <!-- Cliente -->
                <div class="config-group">
                    <h4><i class="fas fa-user-shield"></i> IDENTIFICAÇÃO DO CLIENTE</h4>
                    <div class="config-inputs">
                        <input type="text" id="clientName" placeholder="Nome Completo do Cliente" style="flex: 2;">
                        <input type="text" id="clientNIF" placeholder="NIF (9 dígitos)" style="flex: 1;">
                        <button id="setClientBtn" class="config-btn">
                            <i class="fas fa-fingerprint"></i> REGISTAR CLIENTE
                        </button>
                    </div>
                </div>
                
                <!-- Ano -->
                <div class="config-group">
                    <h4><i class="fas fa-calendar-alt"></i> PERÍODO DE ANÁLISE</h4>
                    <select id="yearSelect" class="config-select">
                        <option value="2018">2018</option>
                        <option value="2019">2019</option>
                        <option value="2020">2020</option>
                        <option value="2021">2021</option>
                        <option value="2022">2022</option>
                        <option value="2023">2023</option>
                        <option value="2024">2024</option>
                        <option value="2025" selected>2025</option>
                        <option value="2026">2026</option>
                        <option value="2027">2027</option>
                        <option value="2028">2028</option>
                        <option value="2029">2029</option>
                        <option value="2030">2030</option>
                        <option value="2031">2031</option>
                        <option value="2032">2032</option>
                        <option value="2033">2033</option>
                        <option value="2034">2034</option>
                        <option value="2035">2035</option>
                        <option value="2036">2036</option>

                    </select>
                </div>
                
                <!-- Plataforma -->
                <div class="config-group">
                    <h4><i class="fas fa-mobile-alt"></i> PLATAFORMA DE ORIGEM</h4>
                    <select id="platformSelect" class="config-select">
                        <option value="bolt">Bolt (Estónia)</option>
                        <option value="uber">Uber (Holanda)</option>
                        <option value="outra">Outra Plataforma</option>
                    </select>
                </div>
                
                <!-- Status do Cliente -->
                <div id="clientStatus" class="status-message" style="display: none; grid-column: 1 / -1;">
                    <i class="fas fa-user-check"></i> CLIENTE REGISTADO: <span id="currentClient" style="font-weight: bold;">Aguardando...</span>
                    | EXERCÍCIO: <span id="currentYear" style="font-weight: bold;">2025</span>
                    | ORIGEM: <span id="currentPlatform" style="font-weight: bold;">Bolt (Estónia)</span>
                </div>
            </div>
        </header>

        <main>
            <!-- SECÇÃO DE CONTROLO DE AUTENTICIDADE (PRIORIDADE) -->
            <div class="control-section" style="margin: 30px 40px; padding: 25px; background: linear-gradient(135deg, rgba(30, 64, 175, 0.2) 0%, rgba(59, 130, 246, 0.1) 100%); border-radius: 15px; border: 2px solid #3b82f6;">
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem; box-shadow: 0 4px 10px rgba(59, 130, 246, 0.4);">
                        <i class="fas fa-key"></i>
                    </div>
                    <h3 style="color: #60a5fa; margin: 0; font-size: 1.3rem;">
                        <i class="fas fa-database"></i> 1. REGISTO DE AUTENTICIDADE (.CSV) - PRIMEIRO PASSO
                    </h3>
                </div>
                
                <div class="control-card">
                    <div class="card-body">
                        <div class="file-input-container">
                            <input type="file" id="controlFile" accept=".csv" class="file-input">
                            <label for="controlFile" class="file-label" style="background: linear-gradient(90deg, #3b82f6 0%, #1d4ed8 100%);">
                                <i class="fas fa-cloud-upload-alt"></i> CARREGAR FICHEIRO DE CONTROLO (.CSV)
                            </label>
                            <div style="margin-top: 10px; font-size: 0.85rem; color: #94a3b8; text-align: center;">
                                <i class="fas fa-info-circle"></i> Formato: "Algorithm","Hash","Path" - Carregue primeiro este ficheiro
                            </div>
                        </div>
                        <div id="controlStatus" class="status-message">
                            <i class="fas fa-clock"></i> AGUARDANDO FICHEIRO DE CONTROLO (PRIORIDADE)
                        </div>
                        
                        <!-- VISUALIZAÇÃO DAS HASHES DE REFERÊNCIA -->
                        <div id="controlHashStatus" class="status-message" style="display: none; margin-top: 10px; background: rgba(30, 64, 175, 0.1);">
                            <i class="fas fa-hashtag"></i> HASHES DE REFERÊNCIA CARREGADAS: <span id="controlHashCount" style="color: #60a5fa; font-weight: bold;">0</span>
                        </div>
                        
                        <div id="controlHashDashboard" style="display: none; margin-top: 20px; background: rgba(15, 23, 42, 0.8); padding: 20px; border-radius: 10px; border: 1px solid rgba(59, 130, 246, 0.2);">
                            <h5 style="color: #93c5fd; font-size: 0.9rem; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-hashtag"></i> REFERÊNCIAS DE AUTENTICIDADE CARREGADAS
                            </h5>
                            <div class="data-grid" style="grid-template-columns: 1fr; gap: 10px;">
                                <div class="data-item">
                                    <span>Hash SAF-T (Referência):</span> 
                                    <span id="hash-saft-ref" style="font-family: 'Monaco', monospace; font-size: 0.7rem; color: #93c5fd; word-break: break-all; text-align: right;">NÃO CARREGADA</span>
                                </div>
                                <div class="data-item">
                                    <span>Hash Fatura (Referência):</span> 
                                    <span id="hash-fatura-ref" style="font-family: 'Monaco', monospace; font-size: 0.7rem; color: #93c5fd; word-break: break-all; text-align: right;">NÃO CARREGADA</span>
                                </div>
                                <div class="data-item">
                                    <span>Hash Extrato (Referência):</span> 
                                    <span id="hash-extrato-ref" style="font-family: 'Monaco', monospace; font-size: 0.7rem; color: #93c5fd; word-break: break-all; text-align: right;">NÃO CARREGADA</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Painel de Uploads de Documentos (INICIALMENTE DESATIVADO) -->
            <div class="upload-section" id="documentUploadSection" style="opacity: 0.5; pointer-events: none; transition: all 0.3s ease;">
                <!-- 2. SAF-T -->
                <div class="upload-card">
                    <div class="card-header">
                        <span class="step-number">2</span>
                        <h4><i class="fas fa-file-csv"></i> FICHEIRO SAF-T (CSV)</h4>
                        <span class="validation-badge" id="saftValidationBadge" style="margin-left: auto; display: none;"></span>
                    </div>
                    <div class="card-body">
                        <div class="file-input-container">
                            <input type="file" id="saftFile" accept=".csv" class="file-input" disabled>
                            <label for="saftFile" class="file-label disabled">
                                <i class="fas fa-cloud-upload-alt"></i> CARREGAR FICHEIRO SAF-T
                                <span style="margin-left: auto; font-size: 0.8rem; opacity: 0.8;">
                                    <i class="fas fa-lock"></i> AGUARDANDO CONTROLO
                                </span>
                            </label>
                        </div>
                        <div id="saftStatus" class="status-message">
                            <i class="fas fa-clock"></i> AGUARDANDO FICHEIRO DE CONTROLO...
                        </div>
                        <div id="saftHashStatus" class="status-message" style="display: none; margin-top: 10px;">
                            <i class="fas fa-hashtag"></i> HASH CALCULADA: <span id="saftHashCalculada" style="color: #93c5fd; font-family: 'Monaco', monospace; font-size: 0.7rem; word-break: break-all;">-</span>
                        </div>
                        <div id="saftValidationStatus" class="status-message" style="display: none; margin-top: 5px;">
                            <i class="fas fa-hashtag"></i> HASH OFICIAL (CSV): <span id="saftHashOficial" style="color: #f59e0b; font-family: 'Monaco', monospace; font-size: 0.7rem; word-break: break-all;">-</span>
                        </div>
                        <div class="data-preview" id="saftPreview" style="display: none;">
                            <h5><i class="fas fa-table"></i> METADADOS DO FICHEIRO SAF-T:</h5>
                            <div class="data-grid">
                                <div class="data-item"><span>Nome do Ficheiro:</span> <span id="saftFileName" style="color: #93c5fd;">-</span></div>
                                <div class="data-item"><span>Tamanho:</span> <span id="saftFileSize" style="color: #93c5fd;">-</span></div>
                                <div class="data-item"><span>Total de Registos:</span> <span id="saftRegistos">0</span></div>
                                <div class="data-item"><span>Ilíquido (Índice 14):</span> <span id="saftIliquido">0,00€</span></div>
                                <div class="data-item"><span>IVA 6% (Índice 13):</span> <span id="saftIVA">0,00€</span></div>
                                <div class="data-item"><span>Total (Índice 15):</span> <span id="saftBruto">0,00€</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3. Fatura Comissão -->
                <div class="upload-card">
                    <div class="card-header">
                        <span class="step-number">3</span>
                        <h4><i class="fas fa-file-invoice-euro"></i> FATURA DE COMISSÃO</h4>
                        <span class="validation-badge" id="invoiceValidationBadge" style="margin-left: auto; display: none;"></span>
                    </div>
                    <div class="card-body">
                        <div class="file-input-container">
                            <input type="file" id="invoiceFile" accept=".pdf,.txt" class="file-input" disabled>
                            <label for="invoiceFile" class="file-label disabled">
                                <i class="fas fa-cloud-upload-alt"></i> CARREGAR FATURA (PDF ou TXT)
                                <span style="margin-left: auto; font-size: 0.8rem; opacity: 0.8;">
                                    <i class="fas fa-lock"></i> AGUARDANDO CONTROLO
                                </span>
                            </label>
                            <div style="margin-top: 10px; font-size: 0.8rem; color: #94a3b8;">
                                <i class="fas fa-info-circle"></i> Para PDFs, extraia o texto primeiro ou use ficheiro TXT
                            </div>
                        </div>
                        <div id="invoiceStatus" class="status-message">
                            <i class="fas fa-clock"></i> AGUARDANDO FICHEIRO DE CONTROLO...
                        </div>
                        <div id="invoiceHashStatus" class="status-message" style="display: none; margin-top: 10px;">
                            <i class="fas fa-hashtag"></i> HASH CALCULADA: <span id="invoiceHashCalculada" style="color: #93c5fd; font-family: 'Monaco', monospace; font-size: 0.7rem; word-break: break-all;">-</span>
                        </div>
                        <div id="invoiceValidationStatus" class="status-message" style="display: none; margin-top: 5px;">
                            <i class="fas fa-hashtag"></i> HASH OFICIAL (CSV): <span id="invoiceHashOficial" style="color: #f59e0b; font-family: 'Monaco', monospace; font-size: 0.7rem; word-break: break-all;">-</span>
                        </div>
                        <div class="data-preview" id="invoicePreview" style="display: none;">
                            <h5><i class="fas fa-receipt"></i> METADADOS DA FATURA:</h5>
                            <div class="data-grid">
                                <div class="data-item"><span>Nome do Ficheiro:</span> <span id="invoiceFileName" style="color: #93c5fd;">-</span></div>
                                <div class="data-item"><span>Tamanho:</span> <span id="invoiceFileSize" style="color: #93c5fd;">-</span></div>
                                <div class="data-item"><span>Referência Fatura:</span> <span id="invoiceReference" style="color: #3b82f6;">-</span></div>
                                <div class="data-item"><span>Total Faturado (EUR):</span> <span id="invoiceTotal">0,00€</span></div>
                                <div class="data-item"><span>IVA Estimado (23%):</span> <span id="invoiceIVA">0,00€</span></div>
                                <div class="data-item"><span>Regime de Autoliquidação:</span> <span id="invoiceRegime" style="color: #f59e0b;">Não identificado</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 4. Extrato/Transferências -->
                <div class="upload-card">
                    <div class="card-header">
                        <span class="step-number">4</span>
                        <h4><i class="fas fa-file-invoice-dollar"></i> EXTRATO BANCÁRIO</h4>
                        <span class="validation-badge" id="statementValidationBadge" style="margin-left: auto; display: none;"></span>
                    </div>
                    <div class="card-body">
                        <div class="file-input-container">
                            <input type="file" id="statementFile" accept=".pdf,.jpg,.jpeg,.png,.csv,.txt" class="file-input" disabled>
                            <label for="statementFile" class="file-label disabled">
                                <i class="fas fa-cloud-upload-alt"></i> CARREGAR EXTRATO
                                <span style="margin-left: auto; font-size: 0.8rem; opacity: 0.8;">
                                    <i class="fas fa-lock"></i> AGUARDANDO CONTROLO
                                </span>
                            </label>
                        </div>
                        <div id="statementStatus" class="status-message">
                            <i class="fas fa-clock"></i> AGUARDANDO FICHEIRO DE CONTROLO...
                        </div>
                        <div id="statementHashStatus" class="status-message" style="display: none; margin-top: 10px;">
                            <i class="fas fa-hashtag"></i> HASH CALCULADA: <span id="statementHashCalculada" style="color: #93c5fd; font-family: 'Monaco', monospace; font-size: 0.7rem; word-break: break-all;">-</span>
                        </div>
                        <div id="statementValidationStatus" class="status-message" style="display: none; margin-top: 5px;">
                            <i class="fas fa-hashtag"></i> HASH OFICIAL (CSV): <span id="statementHashOficial" style="color: #f59e0b; font-family: 'Monaco', monospace; font-size: 0.7rem; word-break: break-all;">-</span>
                        </div>
                        <div class="data-preview" id="statementPreview" style="display: none;">
                            <h5><i class="fas fa-bank"></i> METADADOS DO EXTRATO:</h5>
                            <div class="data-grid">
                                <div class="data-item"><span>Nome do Ficheiro:</span> <span id="statementFileName" style="color: #93c5fd;">-</span></div>
                                <div class="data-item"><span>Tamanho:</span> <span id="statementFileSize" style="color: #93c5fd;">-</span></div>
                                <div class="data-item"><span>Total Recebido:</span> <span id="totalRecebido" style="color: #3b82f6;">0,00€</span></div>
                                <div class="data-item"><span>Comissão da App (Real):</span> <span id="comissaoReal" style="color: #ef4444;">0,00€</span></div>
                                <div class="data-item"><span>Ganhos Campanha:</span> <span id="ganhosCampanha">0,00€</span></div>
                                <div class="data-item"><span>Gorjetas:</span> <span id="gorjetas">0,00€</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Botão de Análise -->
            <div class="analyze-section">
                <button id="analyzeBtn" class="analyze-btn" disabled>
                    <i class="fas fa-search"></i> EXECUTAR ANÁLISE FORENSE
                </button>
                <div class="progress-container" id="progressContainer" style="display: none;">
                    <div class="progress-bar" id="progressBar"></div>
                    <span class="progress-text" id="progressText">0%</span>
                </div>
            </div>

            <!-- Tabela de Análise Comparativa -->
            <div class="analysis-section" id="analysisSection" style="display: none;">
                <h3><i class="fas fa-chart-line"></i> ANÁLISE COMPARATIVA FORENSE - <span id="analysisClient">CLIENTE</span></h3>
                <table class="analysis-table">
                    <thead>
                        <tr>
                            <th>DOCUMENTO/ORIGEM</th>
                            <th>COMISSÃO REAL (EXTRATO)</th>
                            <th>COMISSÃO FATURADA</th>
                            <th>DIVERGÊNCIA DETETADA</th>
                            <th>STATUS PERICIAL</th>
                        </tr>
                    </thead>
                    <tbody id="analysisTableBody"></tbody>
                </table>
            </div>

            <!-- Cálculo Tributário -->
            <div class="tax-section" id="taxSection" style="display: none;">
                <h3><i class="fas fa-calculator"></i> CÁLCULO TRIBUTÁRIO PERICIAL - <span id="taxClient">CLIENTE</span></h3>
                
                <!-- SMOKING GUN - PROVA RAINHA -->
                <div class="smoking-gun" style="margin-bottom: 30px; padding: 25px; background: linear-gradient(135deg, rgba(127, 29, 29, 0.1) 0%, rgba(220, 38, 38, 0.1) 100%); border-radius: 10px; border: 2px solid #dc2626;">
                    <h4 style="color: #dc2626; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-exclamation-triangle"></i> PROVA RAINHA (SMOKING GUN) - DIVERGÊNCIA CRÍTICA
                    </h4>
                    <div class="data-grid" style="grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div class="data-item" style="background: rgba(16, 185, 129, 0.1); padding: 12px; border-radius: 8px;">
                            <span>Comissão Retida (Extrato):</span> <span id="comissaoExtrato" style="color: #10b981; font-weight: bold; font-size: 1.1rem;">239,86€</span>
                        </div>
                        <div class="data-item" style="background: rgba(239, 68, 68, 0.1); padding: 12px; border-radius: 8px;">
                            <span>Comissão Faturada (Bolt):</span> <span id="comissaoFaturada" style="color: #ef4444; font-weight: bold; font-size: 1.1rem;">69,47€</span>
                        </div>
                        <div class="data-item" style="grid-column: 1 / -1; background: rgba(220, 38, 38, 0.2); padding: 15px; border-radius: 8px; border: 2px solid #dc2626;">
                            <span>DIVERGÊNCIA DE BASE (OMISSÃO):</span> <span id="divergenciaBase" style="color: #dc2626; font-size: 1.3rem; font-weight: bold;">170,39€ (71%)</span>
                        </div>
                        <div class="data-item" style="grid-column: 1 / -1; background: rgba(245, 158, 11, 0.1); padding: 12px; border-radius: 8px;">
                            <span>IVA EM FALTA (23% sobre divergência):</span> <span id="ivaFalta" style="color: #f59e0b; font-size: 1.2rem; font-weight: bold;">39,19€</span>
                        </div>
                    </div>
                </div>
                
                <div class="tax-grid">
                    <div class="tax-card">
                        <h4>IVA EM FALTA (23%):</h4>
                        <div class="tax-value" id="ivaValue">€0,00</div>
                        <small>Artigo 2.º, n.º 1, alínea i) CIVA</small>
                    </div>
                    <div class="tax-card">
                        <h4>DIVERGÊNCIA COMISSÃO</h4>
                        <div class="status-badge" id="divergenceStatus">AGUARDANDO</div>
                        <small>Matriz de Divergência</small>
                    </div>
                    <div class="tax-card">
                        <h4>IMPACTO IRC (22.5%):</h4>
                        <div class="risk-level critical" id="impactoIRC">€0,00</div>
                        <small>IRC + Derrama sobre divergência</small>
                    </div>
                    <div class="tax-card">
                        <h4>SELO DE INTEGRIDADE</h4>
                        <div class="hash-value" id="hashValue" style="font-size: 0.65rem; line-height: 1.1;">AGUARDANDO CARREGAMENTO DO REGISTO DE CONTROLO</div>
                        <small>Master Hash SHA-256 (baseada em referência)</small>
                    </div>
                </div>
                
                <!-- Gráficos -->
                <div style="margin-top: 40px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                    <div style="background: rgba(15,23,42,0.7); padding: 20px; border-radius: 10px;">
                        <h4 style="color: #60a5fa; margin-bottom: 15px;"><i class="fas fa-chart-bar"></i> DISCREPÂNCIA DE COMISSÃO</h4>
                        <canvas id="comissaoChart"></canvas>
                    </div>
                    <div style="background: rgba(15,23,42,0.7); padding: 20px; border-radius: 10px;">
                        <h4 style="color: #60a5fa; margin-bottom: 15px;"><i class="fas fa-chart-pie"></i> DISTRIBUIÇÃO DE IMPACTOS FISCAIS</h4>
                        <canvas id="ivaChart"></canvas>
                    </div>
                </div>
                
                <!-- PARECER TÉCNICO FORENSE DINÂMICO -->
                <div class="technical-details" id="parecerTecnico" style="margin-top: 30px; padding: 20px; background: rgba(15,23,42,0.8); border-radius: 10px; display: none;">
                    <h4 style="color: #60a5fa; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-gavel"></i> PARECER TÉCNICO FORENSE DINÂMICO
                    </h4>
                    <div style="background: rgba(30, 41, 59, 0.5); padding: 20px; border-radius: 8px; border-left: 4px solid #dc2626;">
                        <h5 style="color: #dc2626; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 0.5px;">
                            PARECER TÉCNICO N.º VDC-PF/2026/001
                        </h5>
                        
                        <div style="margin-bottom: 15px;">
                            <h6 style="color: #93c5fd; margin-bottom: 8px;">I. ANÁLISE PERICIAL:</h6>
                            <p style="color: #cbd5e1; font-size: 0.95rem; line-height: 1.5;">
                                <span id="parecerAnalise">Discrepância grave detetada entre valores retidos pela Bolt e valores faturados.</span>
                            </p>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <h6 style="color: #93c5fd; margin-bottom: 8px;">II. FATOS CONSTATADOS:</h6>
                            <ol style="color: #cbd5e1; font-size: 0.95rem; padding-left: 20px; line-height: 1.5;">
                                <li>Comissão Real Retida (Extrato): <span id="parecerComissaoReal" style="color: #10b981; font-weight: bold;">239,86€</span>.</li>
                                <li>Valor Faturado (Fatura): <span id="parecerComissaoFaturada" style="color: #ef4444; font-weight: bold;">69,47€</span>.</li>
                                <li>Diferença Omitida: <span id="parecerDivergencia" style="color: #dc2626; font-weight: bold;">170,39€</span> <span id="parecerPercentagem" style="color: #f59e0b;">(71.04% do valor retido)</span>.</li>
                            </ol>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <h6 style="color: #93c5fd; margin-bottom: 8px;">III. ENQUADRAMENTO LEGAL:</h6>
                            <p style="color: #cbd5e1; font-size: 0.95rem; line-height: 1.5;">
                                <span id="parecerLegal">Violação do Artigo 2.º, n.º 1, alínea i) do CIVA (Autoliquidação) e indícios de infração ao Artigo 108.º do CIVA.</span>
                            </p>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <h6 style="color: #93c5fd; margin-bottom: 8px;">IV. IMPACTO FISCAL E PROJEÇÃO SISTÉMICA:</h6>
                            <ul style="color: #cbd5e1; font-size: 0.95rem; padding-left: 20px; line-height: 1.5;">
                                <li>IVA em falta (23%): <span id="parecerIVA" style="color: #f59e0b; font-weight: bold;">39,19€</span> omitidos ao erário público.</li>
                                <li>Impacto IRC/Derrama (22.5%): <span id="parecerImpactoIRC" style="color: #f59e0b; font-weight: bold;">38,34€</span> sobre divergência.</li>
                                <li><span id="parecerFiscal">Impacto Mensal Global (extrapolação 38.000 motoristas): <span id="parecerImpactoMensalGlobal" style="color: #dc2626; font-weight: bold;">6.474.820,00€</span>.</span></li>
                                <li>Impacto Anual Global (×12 meses): <span id="parecerImpactoAnualGlobal" style="color: #dc2626; font-weight: bold;">77.697.840,00€</span>.</li>
                                <li><span id="parecerImpacto7Anos">Projeção a 7 anos (38.000 motoristas × 12 meses × 7 anos): <span id="parecerImpacto7AnosValor" style="color: #dc2626; font-weight: bold;">543.884.880,00€</span>.</span></li>
                            </ul>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <h6 style="color: #93c5fd; margin-bottom: 8px;">V. AUTENTICIDADE E VALIDAÇÃO EXTERNA:</h6>
                            <p style="color: #cbd5e1; font-size: 0.95rem; line-height: 1.5;">
                                <span id="parecerAutenticidade">As hashes dos ficheiros processados foram validadas contra o registo oficial de controlo.</span>
                            </p>
                            <p style="color: #94a3b8; font-size: 0.8rem; font-family: 'Monaco', 'Courier New', monospace; margin-top: 5px; word-break: break-all;">
                                <span id="parecerMasterHash">AGUARDANDO GERAÇÃO DE MASTER HASH...</span>
                            </p>
                        </div>
                        
                        <div>
                            <h6 style="color: #93c5fd; margin-bottom: 8px;">VI. CONCLUSÃO ESTRATÉGICA:</h6>
                            <p style="color: #cbd5e1; font-size: 0.95rem; line-height: 1.5; font-weight: bold;">
                                A materialidade da omissão (71.04%) configura um risco sistémico. Este relatório serve de suporte técnico para procedimentos de regularização voluntária ou interpelação judicial por quebra de conformidade fiscal da entidade emissora.
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- Detalhes Técnicos -->
                <div class="technical-details" style="margin-top: 30px; padding: 20px; background: rgba(15,23,42,0.8); border-radius: 10px;">
                    <h4 style="color: #60a5fa; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-microscope"></i> DETALHES TÉCNICOS DA ANÁLISE
                    </h4>
                    <div class="data-grid" style="grid-template-columns: repeat(3, 1fr);">
                        <div class="data-item"><span>Ficheiro SAF-T:</span> <span id="detSaftFile">-</span></div>
                        <div class="data-item"><span>Ficheiro Fatura:</span> <span id="detInvoiceFile">-</span></div>
                        <div class="data-item"><span>Ficheiro Extrato:</span> <span id="detStatementFile">-</span></div>
                        <div class="data-item"><span>Referência Fatura:</span> <span id="detInvoiceRef" style="color: #3b82f6;">-</span></div>
                        <div class="data-item"><span>Regime Autoliquidação:</span> <span id="detAutoliquidação" style="color: #10b981;">-</span></div>
                        <div class="data-item"><span>Timestamp Análise:</span> <span id="detTimestamp">-</span></div>
                    </div>
                </div>
            </div>

            <!-- Botões de Ação -->
            <div class="action-buttons" id="actionButtons" style="display: none; margin: 40px 0; text-align: center; gap: 20px; justify-content: center;">
                <button id="generateReportBtn" class="action-btn report-btn" disabled style="opacity: 0.5; cursor: not-allowed;">
                    <i class="fas fa-file-pdf"></i> GERAR E SELAR RELATÓRIO PDF
                </button>
                <button id="saveReportBtn" class="action-btn save-btn" disabled style="opacity: 0.5; cursor: not-allowed;">
                    <i class="fas fa-save"></i> GUARDAR ANÁLISE COMPLETA
                </button>
            </div>

            <!-- Metodologia e Fundamentos -->
            <div class="methodology-section">
                <div class="methodology-card">
                    <h4><i class="fas fa-gavel"></i> ENQUADRAMENTO LEGAL</h4>
                    <p><strong>Artigo 2.º, n.º 1, alínea i) do Código do IVA:</strong> Regime de autoliquidação aplicável a serviços prestados por sujeitos passivos não residentes em território português.</p>
                    <ul>
                        <li><strong>IVA Omitido:</strong> 23% sobre comissão real vs faturada</li>
                        <li><strong>Base Tributável:</strong> Diferença detetada na matriz</li>
                        <li><strong>Prazo Regularização:</strong> 30 dias após deteção</li>
                        <li><strong>Sanções Aplicáveis:</strong> Artigo 108.º do CIVA</li>
                    </ul>
                </div>

                <div class="methodology-card">
                    <h4><i class="fas fa-balance-scale"></i> METODOLOGIA PERICIAL</h4>
                    <p><strong>BTOR (Bank Transactions Over Reality):</strong> Análise comparativa entre movimentos bancários reais e documentação fiscal declarada.</p>
                    <ul>
                        <li>Mapeamento posicional de dados SAF-T</li>
                        <li>Extração precisa de valores de extrato</li>
                        <li>Cálculo de divergência automático</li>
                        <li>Geração de prova técnica auditável</li>
                    </ul>
                </div>

                <div class="methodology-card">
                    <h4><i class="fas fa-shield-alt"></i> VALIDAÇÃO HIERÁRQUICA</h4>
                    <p>Sistema de prioridade de ingestão: primeiro carregamento do registo de autenticidade (.csv), depois validação dos documentos fiscais contra hashes de referência.</p>
                    <div class="data-grid" style="margin-top: 15px;">
                        <div class="data-item"><span>Algoritmo Hash:</span> <span style="color: #10b981;">SHA-256</span></div>
                        <div class="data-item"><span>Validação Externa:</span> <span style="color: #f59e0b;">Registo .csv</span></div>
                        <div class="data-item"><span>Validade Prova:</span> <span style="color: #10b981;">Indeterminada</span></div>
                        <div class="data-item"><span>Certificação:</span> <span style="color: #f59e0b;">VDC Forense v5.0</span></div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer>
            <div class="footer-content">
                <p><i class="fas fa-shield-alt"></i> <strong>VDC - UNIDADE DE PERITAGEM FORENSE v5.1</strong> | SISTEMA CERTIFICADO DE AUDITORIA FISCAL</p>
                <p class="timestamp"><i class="fas fa-database"></i> VALIDAÇÃO HIERÁRQUICA: PRIORIDADE DE INGESTÃO DO REGISTO DE AUTENTICIDADE</p>
                <p class="timestamp"><i class="fas fa-clock"></i> TIMESTAMP: <span id="currentTimestamp">carregando...</span></p>
                <p class="timestamp">
                    <i class="fas fa-hashtag"></i> MASTER HASH: 
                    <br>
                    <span id="currentMasterHash" style="display: block; color: #93c5fd; font-family: 'Monaco', 'Courier New', monospace; font-size: 0.75rem; word-break: break-all; margin-top: 3px; line-height: 1.2;">
                        AGUARDANDO CONTROLO...
                    </span>
                </p>
                <p style="color: #64748b; font-size: 0.8rem; margin-top: 5px;">
                    © 2024-2026 VDC - VOZ DO CONDUTOR | PERITAGEM FISCAL
                </p>
            </div>
        </footer>
    </div>

    <!-- Scripts externos -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Script Local -->
    <script src="script.js"></script>
</body>
</html>
