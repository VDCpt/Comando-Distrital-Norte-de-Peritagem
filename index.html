<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VDC | Sistema de Peritagem Forense v5.5</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@300;400&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Overlay de Carregamento -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner">
                <i class="fas fa-fingerprint fa-spin"></i>
            </div>
            <h2>VDC SISTEMA DE PERITAGEM FORENSE v5.5</h2>
            <p>Versão 5.5 | Inicializando Terminal de Análise Big Data...</p>
            <div class="loading-progress">
                <div class="loading-progress-bar" id="loadingProgress"></div>
            </div>
        </div>
    </div>

    <!-- Mensagem de Erro -->
    <div id="errorMessage" class="error-message" style="display: none;">
        <div class="error-content">
            <i class="fas fa-exclamation-triangle"></i>
            <span id="errorText">Erro no sistema</span>
            <button class="error-close" onclick="document.getElementById('errorMessage').style.display='none'">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <!-- Conteúdo Principal -->
    <div id="mainContainer" class="main-container" style="display: none;">
        
        <!-- Cabeçalho -->
        <header class="main-header">
            <div class="header-content">
                <div class="logo-section">
                    <i class="fas fa-balance-scale"></i>
                    <h1>VDC FORENSIC SYSTEM <span class="version-badge">v5.5</span></h1>
                </div>
                <div class="session-info">
                    <div class="system-controls">
                        <div class="control-group">
                            <label for="selYear"><i class="fas fa-calendar-alt"></i> Ano Fiscal</label>
                            <select id="selYear" class="year-select">
                                <!-- Preenchido dinamicamente -->
                            </select>
                        </div>
                        <div class="control-group">
                            <label for="selPlatform"><i class="fas fa-globe-europe"></i> Plataforma</label>
                            <select id="selPlatform" class="platform-select">
                                <option value="bolt">Bolt (Estónia)</option>
                                <option value="uber">Uber (Holanda)</option>
                                <option value="other">Outra Plataforma</option>
                            </select>
                        </div>
                    </div>
                    <div class="timestamp">
                        <i class="fas fa-clock"></i>
                        <span id="currentTime">00:00:00</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Dashboard de Estatísticas Big Data -->
        <section class="dashboard-stats">
            <div class="stat-box">
                <h4><i class="fas fa-euro-sign"></i> VALOR ILÍQUIDO</h4>
                <p id="netVal">0.00€</p>
                <small>Base tributável SAF-T</small>
            </div>
            <div class="stat-box">
                <h4><i class="fas fa-percentage"></i> IVA (6%)</h4>
                <p id="iva6Val">0.00€</p>
                <small>Taxa reduzida Portugal</small>
            </div>
            <div class="stat-box">
                <h4><i class="fas fa-chart-line"></i> TOTAL BRUTO SAF-T</h4>
                <p id="grossVal">0.00€</p>
                <small>Consolidação múltiplos ficheiros</small>
            </div>
            <div class="stat-box alert">
                <h4><i class="fas fa-exclamation-triangle"></i> IVA 23% (PLATAFORMA)</h4>
                <p id="iva23Val" class="alert-text">0.00€</p>
                <small>Autoliquidação devida (Art. 2º CIVA)</small>
            </div>
        </section>

        <!-- Grid Principal -->
        <div class="main-grid">
            <!-- Zona de Upload Multi-Ficheiro -->
            <aside class="upload-zone">
                <div class="upload-card" id="controlUploadCard" onclick="document.getElementById('controlFile').click()">
                    <div class="upload-icon">
                        <i class="fas fa-file-csv"></i>
                    </div>
                    <div class="upload-info">
                        <h4>FICHEIRO DE CONTROLO</h4>
                        <p>CSV com hashes de referência</p>
                        <small>Clique ou arraste ficheiro único</small>
                    </div>
                    <input type="file" id="controlFile" class="file-input" accept=".csv" hidden>
                </div>

                <div class="upload-card multi-upload" id="saftUploadCard" onclick="document.getElementById('saftFile').click()">
                    <div class="upload-icon">
                        <i class="fas fa-file-code"></i>
                    </div>
                    <div class="upload-info">
                        <h4>SAF-T / XML (MÚLTIPLOS)</h4>
                        <p>Ficheiros SAF-T do ano selecionado</p>
                        <small>Ctrl+Click para seleção múltipla</small>
                    </div>
                    <input type="file" id="saftFile" class="file-input" multiple accept=".xml,.csv" hidden>
                </div>

                <div class="upload-card multi-upload" id="invoiceUploadCard" onclick="document.getElementById('invoiceFile').click()">
                    <div class="upload-icon">
                        <i class="fas fa-receipt"></i>
                    </div>
                    <div class="upload-info">
                        <h4>FATURAS PLATAFORMA</h4>
                        <p>Faturas da Bolt/Uber (PDF/CSV)</p>
                        <small>Processamento em lote</small>
                    </div>
                    <input type="file" id="invoiceFile" class="file-input" multiple accept=".pdf,.csv,.xml" hidden>
                </div>

                <div class="upload-card multi-upload" id="statementUploadCard" onclick="document.getElementById('statementFile').click()">
                    <div class="upload-icon">
                        <i class="fas fa-university"></i>
                    </div>
                    <div class="upload-info">
                        <h4>EXTRATOS BANCÁRIOS</h4>
                        <p>Extratos de conta (PDF/CSV/TXT)</p>
                        <small>Análise de fluxos financeiros</small>
                    </div>
                    <input type="file" id="statementFile" class="file-input" multiple accept=".pdf,.csv,.txt" hidden>
                </div>

                <div class="legal-box">
                    <h4><i class="fas fa-gavel"></i> ENQUADRAMENTO LEGAL</h4>
                    <p><strong>CIVA Art. 2º nº 1 i)</strong> - Inversão do sujeito passivo (Autoliquidação)</p>
                    <p><strong>Art. 6º nº 6</strong> - Serviços prestados por não residentes</p>
                    <p class="warn-text">Evasão Fiscal: Discrepância entre Faturação e Recebimento</p>
                </div>
            </aside>

            <!-- Núcleo de Análise Forense -->
            <section class="analysis-core">
                <!-- Gráfico de Cruzamento Forense -->
                <div class="chart-container">
                    <canvas id="forensicChart"></canvas>
                    <div class="chart-legend">
                        <span class="legend-item"><i class="fas fa-square" style="color: #00f2ff;"></i> Bruto SAF-T</span>
                        <span class="legend-item"><i class="fas fa-square" style="color: #ff3e3e;"></i> Comissão Plataforma</span>
                        <span class="legend-item"><i class="fas fa-square" style="color: #10b981;"></i> Transferência Real</span>
                    </div>
                </div>

                <!-- Resultados da Análise -->
                <div class="analysis-results" id="analysisResults" style="display:none;">
                    <div class="results-grid">
                        <div class="result-card">
                            <h4><i class="fas fa-calculator"></i> CRUZAMENTO 1</h4>
                            <p id="cross1Result">Aguardando análise...</p>
                            <small>Bruto SAF-T - Comissão vs Transferência</small>
                        </div>
                        <div class="result-card">
                            <h4><i class="fas fa-search-dollar"></i> CRUZAMENTO 2</h4>
                            <p id="cross2Result">Aguardando análise...</p>
                            <small>Faturação (6% IVA) vs Recebimento Líquido</small>
                        </div>
                        <div class="result-card">
                            <h4><i class="fas fa-users"></i> PROJEÇÃO MERCADO</h4>
                            <p id="marketProjection">0.00M€</p>
                            <small>Base: 38.000 operadores ativos</small>
                        </div>
                        <div class="result-card">
                            <h4><i class="fas fa-file-contract"></i> EVIDÊNCIAS</h4>
                            <p id="evidenceCount">0 documentos</p>
                            <small>Processados/Validados</small>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Console de Auditoria e Controles -->
        <footer class="main-footer">
            <div class="console-wrapper">
                <div class="console-title">
                    <i class="fas fa-terminal"></i> CONSOLE DE AUDITORIA
                    <button class="icon-btn" onclick="clearConsole()" title="Limpar console">
                        <i class="fas fa-broom"></i>
                    </button>
                </div>
                <div id="auditOutput" class="console-mini">
                    <!-- Logs serão inseridos aqui -->
                </div>
            </div>

            <div class="action-bar">
                <button id="analyzeBtn" class="btn-main" onclick="performForensicAnalysis()" disabled>
                    <i class="fas fa-search"></i> EXECUTAR ANÁLISE FORENSE
                </button>
                <div class="secondary-actions">
                    <button class="btn-sub" onclick="exportJSON()">
                        <i class="fas fa-code"></i> PROVA DIGITAL (JSON)
                    </button>
                    <button class="btn-sub" onclick="exportPDF()">
                        <i class="fas fa-file-pdf"></i> RELATÓRIO PERICIAL (PDF)
                    </button>
                    <button class="btn-sub" onclick="clearSession()">
                        <i class="fas fa-redo"></i> NOVA SESSÃO
                    </button>
                </div>
            </div>

            <div class="system-info">
                <div class="master-hash">
                    <strong><i class="fas fa-fingerprint"></i> MASTER HASH DA SESSÃO:</strong>
                    <span id="masterHashValue">AGUARDANDO GERAÇÃO...</span>
                </div>
                <div class="copyright">
                    <i class="fas fa-shield-alt"></i> VDC Sistema de Peritagem Forense v5.5 | Big Data Forense | © 2024
                </div>
            </div>
        </footer>
    </div>

    <script src="script.js"></script>
</body>
</html>
