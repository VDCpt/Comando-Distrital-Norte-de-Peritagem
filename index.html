// ============================================
// VDC SISTEMA DE PERITAGEM FORENSE v11.6 GATEKEEPER
// AUDITORIA FISCAL BIG DATA - THE CHECKMATE
// CORREÃ‡ÃƒO CIRÃšRGICA: SPLASH MANUAL + PARSING BOLT/CSV + EVENTOS ATIVOS
// ============================================

// ============================================
// NÃšCLEO DO SISTEMA - ESTADO GLOBAL (RETIFICADO)
// ============================================
const VDCSystem = {
    documents: [],
    currentClient: { 
        name: '', 
        nif: '', 
        year: new Date().getFullYear() 
    },
    analysis: { 
        gross: 0, 
        transfer: 0, 
        difference: 0, 
        marketValue: 0 
    },
    chart: null
};

// ============================================
// MÃ“DULO 1: GATEKEEPER - CONTROLO DE SPLASH SCREEN MANUAL
// ============================================

document.addEventListener('DOMContentLoaded', () => {
    console.log("ðŸ” VDC v11.6 GATEKEEPER: Sistema Inicializado.");
    
    // GATEKEEPER: ACESSO VIA CLIQUE (RETIFICADO)
    const startBtn = document.getElementById('startSessionBtn');
    const splashScreen = document.getElementById('splashScreen');
    const mainContainer = document.getElementById('mainContainer');
    
    if (startBtn && splashScreen && mainContainer) {
        startBtn.addEventListener('click', () => {
            logAudit("ðŸ”“ ACESSO AUTORIZADO: SessÃ£o Iniciada.", "success");
            
            splashScreen.style.opacity = '0';
            setTimeout(() => {
                splashScreen.style.display = 'none';
                mainContainer.style.display = 'block';
                setTimeout(() => {
                    mainContainer.style.opacity = '1';
                    generateMasterHash();
                }, 50);
            }, 500);
        });
    } else {
        console.error("âŒ ERRO CRÃTICO: Elementos GATEKEEPER nÃ£o encontrados!");
    }
    
    // INICIALIZAÃ‡ÃƒO DE COMPONENTES ADICIONAIS
    initializeSystem();
    populateYears();
    setupEventListeners();
    startClock();
});

// ============================================
// MÃ“DULO 2: INICIALIZAÃ‡ÃƒO DO SISTEMA
// ============================================

function initializeSystem() {
    logAudit("ðŸ›¡ï¸ SISTEMA VDC v11.6 GATEKEEPER: Protocolo de Integridade Ativo.", "success");
    logAudit("ðŸ“‹ ISO/IEC 27037 | NIST SP 800-86 | SHA-256 Hash Protocol", "info");
}

function populateYears() {
    const select = document.getElementById('auditYear');
    if (!select) return;
    
    const currentYear = new Date().getFullYear();
    select.innerHTML = '';
    
    for (let year = currentYear; year >= currentYear - 10; year--) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        if (year === currentYear) option.selected = true;
        select.appendChild(option);
    }
}

function startClock() {
    function updateTime() {
        const now = new Date();
        const dateElement = document.getElementById('currentDate');
        const timeElement = document.getElementById('currentTime');
        
        if (dateElement) {
            dateElement.textContent = now.toLocaleDateString('pt-PT', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }
        
        if (timeElement) {
            timeElement.textContent = now.toLocaleTimeString('pt-PT', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }
    }
    
    updateTime();
    setInterval(updateTime, 1000);
}

// ============================================
// MÃ“DULO 3: SETUP DE EVENT LISTENERS - REATIVADO
// ============================================

function setupEventListeners() {
    // BOTÃ•ES PRINCIPAIS
    setupButton('uploadBtn', openEvidenceModal);
    setupButton('demoModeBtn', activateDemoMode);
    setupButton('analyzeBtn', executeAnalysis);
    setupButton('reportBtn', generateReport);
    setupButton('exportBtn', exportData);
    setupButton('resetBtn', resetSystem);
    
    // MODAL DE EVIDÃŠNCIAS
    setupButton('closeModalBtn', closeEvidenceModal);
    setupButton('closeModalFooterBtn', closeEvidenceModal);
    
    // CONSOLA
    setupButton('clearConsoleBtn', clearConsole);
    setupButton('toggleConsoleBtn', toggleConsole);
    setupButton('custodyBtn', showCustodyChain);
    
    // UPLOAD DE FICHEIROS - CORREÃ‡ÃƒO CRÃTICA
    setupFileUpload('dac7UploadBtnModal', 'dac7FileModal', 'dac7');
    setupFileUpload('controlUploadBtnModal', 'controlFileModal', 'control');
    setupFileUpload('saftUploadBtnModal', 'saftFileModal', 'saft');
    setupFileUpload('invoiceUploadBtnModal', 'invoiceFileModal', 'invoice');
    setupFileUpload('statementUploadBtnModal', 'statementFileModal', 'statement');
    
    logAudit("âœ… Event Listeners Configurados com Sucesso.", "success");
}

function setupButton(id, handler) {
    const btn = document.getElementById(id);
    if (btn && handler) {
        btn.addEventListener('click', handler);
    }
}

function setupFileUpload(buttonId, inputId, type) {
    const button = document.getElementById(buttonId);
    const input = document.getElementById(inputId);
    
    if (button && input) {
        button.addEventListener('click', () => {
            input.click();
        });
        
        input.addEventListener('change', (e) => {
            handleFileUploadModal(e, type);
        });
    }
}

// ============================================
// MÃ“DULO 4: GESTÃƒO DE MODAL
// ============================================

function openEvidenceModal() {
    const modal = document.getElementById('evidenceModal');
    if (modal) {
        modal.style.display = 'flex';
        logAudit("ðŸ“‚ Modal de EvidÃªncias Aberto.", "info");
    }
}

function closeEvidenceModal() {
    const modal = document.getElementById('evidenceModal');
    if (modal) {
        modal.style.display = 'none';
        logAudit("ðŸ“‚ Modal de EvidÃªncias Fechado.", "info");
    }
}

// ============================================
// MÃ“DULO 5: PROCESSAMENTO DE UPLOADS - PARSING BOLT/CSV
// ============================================

function handleFileUploadModal(event, type) {
    const files = Array.from(event.target.files);
    if (files.length === 0) return;
    
    const listId = `${type}FileListModal`;
    const listElement = document.getElementById(listId);
    
    logAudit(`ðŸ“¤ Upload Iniciado: ${files.length} ficheiro(s) de tipo ${type.toUpperCase()}`, "info");
    
    files.forEach(file => {
        processFile(file, type);
        
        if (listElement) {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `
                <span class="file-name">${file.name}</span>
                <span class="file-size">${(file.size / 1024).toFixed(2)} KB</span>
            `;
            listElement.appendChild(fileItem);
        }
    });
    
    updateDashboard();
    updateSummary();
}

function processFile(file, type) {
    const reader = new FileReader();
    
    reader.onload = (e) => {
        const content = e.target.result;
        
        if (type === 'invoice' && file.type === 'application/pdf') {
            parseInvoiceBolt(content, file.name);
        } else if (type === 'statement' && (file.name.endsWith('.csv') || file.name.endsWith('.txt'))) {
            parseStatementCSV(content, file.name);
        } else if (type === 'saft' && file.name.endsWith('.csv')) {
            parseSaftCSV(content, file.name);
        } else if (type === 'dac7') {
            parseDAC7(content, file.name);
        } else {
            VDCSystem.documents.push({
                type,
                name: file.name,
                content,
                hash: generateHash(content),
                timestamp: new Date().toISOString()
            });
        }
        
        logAudit(`âœ… Ficheiro processado: ${file.name} [${type.toUpperCase()}]`, "success");
    };
    
    if (file.type === 'application/pdf') {
        reader.readAsDataURL(file);
    } else {
        reader.readAsText(file);
    }
}

// ============================================
// MÃ“DULO 6: PARSING ESPECÃFICO - BOLT/CSV OTIMIZADO
// ============================================

function parseInvoiceBolt(content, filename) {
    const totalRegex = /Total\s+com\s+IVA[:\s]*â‚¬?\s*(\d+[.,]\d+)/i;
    const match = content.match(totalRegex);
    
    if (match) {
        const value = parseFloat(match[1].replace(',', '.'));
        
        VDCSystem.documents.push({
            type: 'invoice',
            name: filename,
            value,
            hash: generateHash(content),
            timestamp: new Date().toISOString()
        });
        
        logAudit(`ðŸ’° Fatura BOLT: ${filename} = â‚¬${value.toFixed(2)}`, "success");
    } else {
        logAudit(`âš ï¸ Fatura BOLT nÃ£o parseada: ${filename}`, "warn");
    }
}

function parseStatementCSV(content, filename) {
    Papa.parse(content, {
        delimiter: ';',
        header: true,
        skipEmptyLines: true,
        complete: (results) => {
            const rows = results.data;
            let total = 0;
            
            rows.forEach(row => {
                if (row['Total']) {
                    const value = parseFloat(row['Total'].replace(',', '.'));
                    if (!isNaN(value)) total += value;
                } else if (row['Valor']) {
                    const value = parseFloat(row['Valor'].replace(',', '.'));
                    if (!isNaN(value)) total += value;
                }
            });
            
            VDCSystem.documents.push({
                type: 'statement',
                name: filename,
                rows: rows.length,
                total,
                hash: generateHash(content),
                timestamp: new Date().toISOString()
            });
            
            logAudit(`ðŸ“Š Extrato CSV: ${filename} | ${rows.length} linhas | Total: â‚¬${total.toFixed(2)}`, "success");
        },
        error: (error) => {
            logAudit(`âŒ Erro ao parsear CSV: ${filename} - ${error.message}`, "error");
        }
    });
}

function parseSaftCSV(content, filename) {
    Papa.parse(content, {
        delimiter: ';',
        header: true,
        skipEmptyLines: true,
        complete: (results) => {
            const rows = results.data;
            
            VDCSystem.documents.push({
                type: 'saft',
                name: filename,
                rows: rows.length,
                data: rows,
                hash: generateHash(content),
                timestamp: new Date().toISOString()
            });
            
            logAudit(`ðŸ“‹ SAF-T CSV: ${filename} | ${rows.length} registos`, "success");
        }
    });
}

function parseDAC7(content, filename) {
    VDCSystem.documents.push({
        type: 'dac7',
        name: filename,
        content,
        hash: generateHash(content),
        timestamp: new Date().toISOString()
    });
    
    logAudit(`ðŸ“„ DAC7 Processado: ${filename}`, "success");
}

// ============================================
// MÃ“DULO 7: MODO DEMO - LIMPEZA DE MEMÃ“RIA
// ============================================

function activateDemoMode() {
    logAudit("ðŸ§ª MODO DEMO ATIVADO: Dados da Momento Eficaz Lda.", "warn");
    
    VDCSystem.documents = [];
    
    VDCSystem.currentClient = {
        name: 'Momento Eficaz Lda',
        nif: '123456789',
        year: 2023
    };
    
    document.getElementById('clientName').value = 'Momento Eficaz Lda';
    document.getElementById('clientNif').value = '123456789';
    document.getElementById('auditYear').value = '2023';
    
    VDCSystem.documents.push(
        {
            type: 'dac7',
            name: 'DAC7_MomentoEficaz_2023.html',
            hash: 'demo-hash-001',
            timestamp: new Date().toISOString()
        },
        {
            type: 'invoice',
            name: 'Fatura_Bolt_2023_001.pdf',
            value: 5420.50,
            hash: 'demo-hash-002',
            timestamp: new Date().toISOString()
        },
        {
            type: 'statement',
            name: 'Extrato_Bancario_2023.csv',
            total: 5100.00,
            rows: 45,
            hash: 'demo-hash-003',
            timestamp: new Date().toISOString()
        }
    );
    
    updateDashboard();
    updateSummary();
    logAudit("âœ… Modo Demo Pronto para AnÃ¡lise.", "success");
}

// ============================================
// MÃ“DULO 8: ANÃLISE E RELATÃ“RIOS
// ============================================

function executeAnalysis() {
    logAudit("ðŸ”¬ EXECUTANDO AUDITORIA BIG DATA...", "info");
    
    const invoices = VDCSystem.documents.filter(d => d.type === 'invoice');
    const statements = VDCSystem.documents.filter(d => d.type === 'statement');
    
    const totalInvoices = invoices.reduce((sum, inv) => sum + (inv.value || 0), 0);
    const totalStatements = statements.reduce((sum, stmt) => sum + (stmt.total || 0), 0);
    const difference = totalInvoices - totalStatements;
    
    VDCSystem.analysis.gross = totalInvoices;
    VDCSystem.analysis.transfer = totalStatements;
    VDCSystem.analysis.difference = difference;
    VDCSystem.analysis.marketValue = totalInvoices * 1.5;
    
    document.getElementById('grossResult').textContent = `â‚¬${totalInvoices.toFixed(2)}`;
    document.getElementById('transferResult').textContent = `â‚¬${totalStatements.toFixed(2)}`;
    document.getElementById('differenceResult').textContent = `â‚¬${difference.toFixed(2)}`;
    document.getElementById('marketResult').textContent = `â‚¬${(VDCSystem.analysis.marketValue / 1000000).toFixed(2)}M`;
    
    if (Math.abs(difference) > 100) {
        const alert = document.getElementById('omissionAlert');
        if (alert) {
            alert.style.display = 'flex';
            document.getElementById('omissionValue').textContent = `â‚¬${Math.abs(difference).toFixed(2)}`;
        }
    }
    
    updateChart();
    logAudit(`âœ… AUDITORIA CONCLUÃDA: DiferenÃ§a = â‚¬${difference.toFixed(2)}`, "success");
}

function updateChart() {
    const ctx = document.getElementById('forensicChart');
    if (!ctx) return;
    
    if (VDCSystem.chart) {
        VDCSystem.chart.destroy();
    }
    
    VDCSystem.chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['FaturaÃ§Ã£o', 'TransferÃªncias', 'DiferenÃ§a'],
            datasets: [{
                label: 'Valores (â‚¬)',
                data: [
                    VDCSystem.analysis.gross,
                    VDCSystem.analysis.transfer,
                    VDCSystem.analysis.difference
                ],
                backgroundColor: [
                    'rgba(0, 242, 255, 0.6)',
                    'rgba(59, 130, 246, 0.6)',
                    'rgba(255, 62, 62, 0.6)'
                ],
                borderColor: [
                    '#00f2ff',
                    '#3b82f6',
                    '#ff3e3e'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: '#b8c6e0'
                    }
                },
                x: {
                    ticks: {
                        color: '#b8c6e0'
                    }
                }
            }
        }
    });
}

function generateReport() {
    logAudit("ðŸ“„ Gerando RelatÃ³rio PDF...", "info");
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    doc.setFontSize(16);
    doc.text('VDC SISTEMA DE PERITAGEM FORENSE', 20, 20);
    doc.setFontSize(12);
    doc.text(`Cliente: ${VDCSystem.currentClient.name}`, 20, 35);
    doc.text(`NIF: ${VDCSystem.currentClient.nif}`, 20, 45);
    doc.text(`Ano: ${VDCSystem.currentClient.year}`, 20, 55);
    doc.text(`FaturaÃ§Ã£o Total: â‚¬${VDCSystem.analysis.gross.toFixed(2)}`, 20, 70);
    doc.text(`TransferÃªncias: â‚¬${VDCSystem.analysis.transfer.toFixed(2)}`, 20, 80);
    doc.text(`DiferenÃ§a: â‚¬${VDCSystem.analysis.difference.toFixed(2)}`, 20, 90);
    
    doc.save(`Relatorio_VDC_${VDCSystem.currentClient.nif}_${Date.now()}.pdf`);
    logAudit("âœ… RelatÃ³rio PDF Gerado.", "success");
}

function exportData() {
    logAudit("ðŸ’¾ Exportando Dados...", "info");
    
    const exportData = {
        client: VDCSystem.currentClient,
        analysis: VDCSystem.analysis,
        documents: VDCSystem.documents.map(d => ({
            type: d.type,
            name: d.name,
            hash: d.hash,
            timestamp: d.timestamp
        }))
    };
    
    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `Export_VDC_${Date.now()}.json`;
    a.click();
    
    logAudit("âœ… Dados Exportados com Sucesso.", "success");
}

function resetSystem() {
    if (!confirm('âš ï¸ Tem a certeza que deseja resetar todo o sistema?')) return;
    
    VDCSystem.documents = [];
    VDCSystem.currentClient = { name: '', nif: '', year: new Date().getFullYear() };
    VDCSystem.analysis = { gross: 0, transfer: 0, difference: 0, marketValue: 0 };
    
    document.getElementById('clientName').value = '';
    document.getElementById('clientNif').value = '';
    clearConsole();
    updateDashboard();
    updateSummary();
    
    if (VDCSystem.chart) VDCSystem.chart.destroy();
    
    logAudit("ðŸ”„ SISTEMA RESETADO.", "warn");
}

// ============================================
// MÃ“DULO 9: ATUALIZAÃ‡ÃƒO DE DASHBOARD
// ============================================

function updateDashboard() {
    const dac7Count = VDCSystem.documents.filter(d => d.type === 'dac7').length;
    const saftCount = VDCSystem.documents.filter(d => d.type === 'saft').length;
    const invoicesCount = VDCSystem.documents.filter(d => d.type === 'invoice').length;
    const statementsCount = VDCSystem.documents.filter(d => d.type === 'statement').length;
    const totalRecords = VDCSystem.documents.length;
    
    document.getElementById('dac7Count').textContent = dac7Count;
    document.getElementById('saftCount').textContent = saftCount;
    document.getElementById('invoicesCount').textContent = invoicesCount;
    document.getElementById('statementsCount').textContent = statementsCount;
    document.getElementById('totalRecords').textContent = totalRecords;
    document.getElementById('hashStatus').textContent = totalRecords > 0 ? 'VERIFICADO' : 'AGUARDANDO';
}

function updateSummary() {
    const dac7Docs = VDCSystem.documents.filter(d => d.type === 'dac7');
    const saftDocs = VDCSystem.documents.filter(d => d.type === 'saft');
    const invoiceDocs = VDCSystem.documents.filter(d => d.type === 'invoice');
    const statementDocs = VDCSystem.documents.filter(d => d.type === 'statement');
    
    document.getElementById('summaryDac7').textContent = `${dac7Docs.length} ficheiros | ${dac7Docs.length} registos`;
    document.getElementById('summarySaft').textContent = `${saftDocs.length} ficheiros | ${saftDocs.reduce((sum, d) => sum + (d.rows || 0), 0)} registos`;
    document.getElementById('summaryInvoices').textContent = `${invoiceDocs.length} ficheiros | ${invoiceDocs.length} registos`;
    document.getElementById('summaryStatements').textContent = `${statementDocs.length} ficheiros | ${statementDocs.reduce((sum, d) => sum + (d.rows || 0), 0)} registos`;
}

// ============================================
// MÃ“DULO 10: CONSOLA DE AUDITORIA
// ============================================

function logAudit(message, type = 'info') {
    const consoleOutput = document.getElementById('auditOutput');
    if (!consoleOutput) return;
    
    const entry = document.createElement('div');
    entry.className = `log-entry log-${type}`;
    entry.innerHTML = `<span class="log-time">[${new Date().toLocaleTimeString('pt-PT')}]</span> ${message}`;
    
    consoleOutput.appendChild(entry);
    consoleOutput.scrollTop = consoleOutput.scrollHeight;
}

function clearConsole() {
    const console = document.getElementById('auditOutput');
    if (console) {
        console.innerHTML = '';
        logAudit("ðŸ§¹ Consola Limpa.", "info");
    }
}

function toggleConsole() {
    const console = document.getElementById('auditOutput');
    if (console) {
        console.classList.toggle('expanded');
    }
}

function showCustodyChain() {
    logAudit("ðŸ”— CADEIA DE CUSTÃ“DIA:", "regulatory");
    VDCSystem.documents.forEach((doc, index) => {
        logAudit(`  ${index + 1}. ${doc.name} | Hash: ${doc.hash ? doc.hash.substring(0, 16) : 'N/A'}...`, "info");
    });
}

// ============================================
// MÃ“DULO 11: HASH GENERATION
// ============================================

function generateHash(content) {
    return CryptoJS.SHA256(content).toString();
}

function generateMasterHash() {
    const systemState = JSON.stringify(VDCSystem);
    const masterHash = CryptoJS.SHA256(systemState).toString();
    
    const hashElement = document.getElementById('masterHashValue');
    if (hashElement) {
        hashElement.textContent = masterHash;
    }
    
    return masterHash;
}

// ============================================
// EXPOSIÃ‡ÃƒO DE FUNÃ‡Ã•ES GLOBAIS
// ============================================

window.populateYears = populateYears;
window.generateMasterHash = generateMasterHash;
window.logAudit = logAudit;

console.log("âœ… VDC v11.6 GATEKEEPER: Todos os MÃ³dulos Carregados com Sucesso.");
